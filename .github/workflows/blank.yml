name: ğŸš€ SEVER AI STV PREMIUM

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ğŸ• Thá»i gian sá»­ dá»¥ng'
        required: false
        default: '24h'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '24h'

jobs:
  Premium-RDP-Setup:
    runs-on: windows-latest
    timeout-minutes: 1440
    
    steps:
      # BANNER CHÃ€O Má»ªNG
      - name: ğŸ¯ KHá»I Äá»˜NG Há»† THá»NG
        run: |
          Write-Host ""
          Write-Host "ğŸ¤– AI STV PREMIUM RDP SERVER" -ForegroundColor Yellow
          Write-Host "ğŸ•’ Thá»i gian: ${{ github.event.inputs.duration }}" -ForegroundColor Magenta

      # Cáº¤U HÃŒNH NÃ‚NG CAO
      - name: ğŸ”§ Cáº¤U HÃŒNH Há»† THá»NG
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name fDenyTSConnections -Value 0 -Force
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Start-Service TermService

      # Táº O USER PREMIUM
      - name: ğŸ‘¤ Táº O TÃ€I KHOáº¢N PREMIUM
        run: |
          $pw="AISTV"+(Get-Random -Maximum 9999)
          net user AISTV-PREMIUM $pw /add
          net localgroup administrators AISTV-PREMIUM /add
          net localgroup "Remote Desktop Users" AISTV-PREMIUM /add
          echo "RDP_PASS=$pw" >> $env:GITHUB_ENV
          echo "$pw" > $env:TEMP\rdp_password.txt

      # TAILSCALE PREMIUM
      - name: ğŸŒ THIáº¾T Láº¬P Máº NG PREMIUM
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          Write-Host "ğŸŒ ÄANG THIáº¾T Láº¬P TAILSCALE" -ForegroundColor Yellow

          # CÃ i Tailscale
          $msi="$env:TEMP\tailscale.msi"
          Invoke-WebRequest https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi -OutFile $msi
          Start-Process msiexec.exe -ArgumentList "/i `"$msi`" /quiet /norestart" -Wait

          Start-Sleep 10
          $tsExe="$env:ProgramFiles\Tailscale\tailscale.exe"

          & $tsExe up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=ai-stv-premium-$env:GITHUB_RUN_ID --accept-routes --accept-dns --reset

          # ===============================
          # ğŸ”¥ IP ROTATE â€“ Láº¤Y IP + XOAY 3 PHÃšT
          # ===============================

          Write-Host "ğŸ”„ Láº¥y IP ban Ä‘áº§u..." -ForegroundColor Blue
          $ip=$null
          for($i=0;$i -lt 20;$i++){
              $ip=& $tsExe ip -4 2>$null
              if($ip -match '^\d+\.\d+\.\d+\.\d+$'){
                  echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
                  Write-Host "âœ… IP ban Ä‘áº§u: $ip" -ForegroundColor Green
                  break
              }
              Start-Sleep 3
          }

          if(-not $ip){
              echo "TAILSCALE_IP=localhost" >> $env:GITHUB_ENV
          }

          # ğŸ” Background job xoay IP má»—i 3 phÃºt
          Start-Job -Name RotateIP -ScriptBlock {
              $tsExe="$env:ProgramFiles\Tailscale\tailscale.exe"
              while($true){
                  Start-Sleep 180   # â±ï¸ 3 phÃºt

                  & $tsExe down --accept-risk=all | Out-Null
                  Start-Sleep 5
                  & $tsExe up `
                    --authkey=$env:TAILSCALE_AUTH_KEY `
                    --hostname=ai-stv-$env:GITHUB_RUN_ID-$(Get-Random) `
                    --accept-routes --accept-dns --reset | Out-Null

                  for($i=0;$i -lt 20;$i++){
                      $newIp=& $tsExe ip -4 2>$null
                      if($newIp -match '^\d+\.\d+\.\d+\.\d+$'){
                          echo "TAILSCALE_IP=$newIp" >> $env:GITHUB_ENV
                          Write-Host "ğŸ” IP má»›i: $newIp" -ForegroundColor Green
                          break
                      }
                      Start-Sleep 3
                  }
              }
          }

      # HIá»‚N THá»Š THÃ”NG TIN
      - name: ğŸ‰ THÃ”NG TIN Káº¾T Ná»I
        run: |
          $pw=Get-Content $env:TEMP\rdp_password.txt
          Write-Host "ğŸŒ IP: $env:TAILSCALE_IP"
          Write-Host "ğŸ‘¤ User: AISTV-PREMIUM"
          Write-Host "ğŸ” Pass: $pw"

      # GIá»® PHIÃŠN
      - name: â³ DUY TRÃŒ PHIÃŠN
        run: |
          Start-Sleep -Seconds 20400

      # Dá»ŒN Dáº¸P
      - name: ğŸ§¹ Dá»ŒN Dáº¸P
        if: always()
        run: |
          Get-Job | Stop-Job -Force | Remove-Job -Force
          net user AISTV-PREMIUM /delete
          & "$env:ProgramFiles\Tailscale\tailscale.exe" down --accept-risk=all
